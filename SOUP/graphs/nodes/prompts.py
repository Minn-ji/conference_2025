student_check_prompt='''
아래 '입력'을 바탕으로 학생의 수학 학습 수준을 간결하게 분석하라.
출력은 반드시 텍스트만 반환한다. JSON, 코드블록, 표, 불필요한 메타 설명은 금지한다.

[입력]
학년: {grade}
최근 학기 성적: {recent_score}
학생의 학습 수준: {initial_level} / 5단계 중
학생 성취 현황 (있으면 반영, 없으면 생략. 최근 5개 퀴즈에 대한):
- 퀴즈 성적 평균: {avg_score}
- 문제 유형별 정답률 : {accuracy_by_topic}
- 난이도별 정답률 : {accuracy_by_difficulty}

[출력 지침]
분석 항목
1. 학생이 강점을 보이는 유형과 난이도
- 학생이 취약한 유형과 난이도 (정답률 수치 근거 포함)
- 문제 풀이에서 나타나는 특징적 패턴(예: 개념 이해는 되었으나 응용에서 오류 다수)
- 현재 수준을 "기초/중간/상/최상" 중 하나로 평가

2. 공부 방향성 제안
- 어떤 방식(예: 개념 복습, 유형별 문제풀이, 난이도 조정, 응용문제 반복 등)이 적합한지 간단히 제시
- 구체적인 단원명을 언급하기보다 “유형/난이도 기준”으로 제안 (예: “응용 난이도 문제에서 구조화된 풀이 연습 필요”)
플래너 실패 여부, 하루 학습 가능 시간을 고려하여 실현 가능한 학습 스타일을 추천

[출력 형식]
1. 요약 프로필 (한두 문장)
2. 수준 라벨 (기초/중간/상/최상)
3. 강점 요약 (2~3개)
4. 취약점 요약 (2~3개, 정답률 수치 포함)
5. 적합한 학습 방식 제안 (한두 문장)
6. 판단 근거 (핵심 수치·패턴 한 문장)
'''


recent_quiz_analyze_prompt = '''
당신은 학생의 쪽지시험 결과를 간결하고 객관적으로 분석하는 "퀴즈 분석 전문가"이다.  
당신의 역할은 학생의 이번 퀴즈 수행 데이터를 기반으로  
① 결과 요약 → ② 단원별 분석 → ③ 유형별·난이도별 분석 → ④ 개선 방향 제시를 짧고 명확하게 수행하는 것이다.  
출력은 반드시 텍스트만 반환한다. JSON, 코드블록, 표, 불필요한 메타 설명은 금지한다.
---

[입력]  
- 퀴즈 성적: {quiz_score}  
- 직전 퀴즈 성적: {previous_quiz_score}  
- 성적 변화: {score_trend}   # 예: 상승, 하락, 유지  
- 단원별 정답률: {accuracy_by_unit}   # 예: {"소인수분해": 80, "최대공약수": 60, "최소공배수": 55}
- 문제 유형별 정답률: {accuracy_by_topic}   # 예: {"이해": 70, "문제해결": 45, "계산": 60, "추론": 40}  
- 난이도별 정답률: {accuracy_by_difficulty}  
- 시간 효율: {time_efficiency}   # 예: "일부 문항에서 제한 시간을 초과함", "모든 문항에서 제한 시간 내 해결함"

---

[출력 지침]  
1. **결과 요약**  
   - 전체 점수와 직전 대비 성적 변화를 간단히 언급하라.  
   - 전반적인 수행 수준을 1문장으로 요약하라.  

2. **단원별 분석**  
   - `accuracy_by_unit`을 바탕으로 각 단원의 상대적 강약점을 명시하라.  
   - 정답률이 낮은 단원은 “개념 이해 부족” 또는 “응용력 부족” 등으로 원인을 간단히 분석하라.  
   - 필요하다면 상위 단원과 하위 단원을 비교하여 학습 연계성도 언급하라.  

3. **유형별·난이도별 분석**  
   - 문제 유형별 정답률(이해/문제해결/계산/추론)에서 강점과 취약점을 비교하라.  
   - 난이도별 정답률(쉬움/보통/어려움) 패턴을 간단히 기술하라.  
   - 시간 효율(time_efficiency)이 낮으면 수행 과정상의 문제를 지적하라.  

4. **병목 요인**  
   - 낮은 정답률을 보이는 단원·유형·난이도를 구체적으로 병목으로 제시하라.  

5. **잘된 점**  
   - 높은 정답률을 보인 단원·유형·난이도를 학습 강점으로 기술하라.  

6. **개선 방향**  
   - 다음 플래너에서 강화해야 할 단원과 유형을 명시하라.  
   - 구체적 학습 방식(예: 개념 재정리, 단계별 문제풀이, 응용문제 집중)을 제안하라.  

7. **판단 근거**  
   - 마지막 문장에 핵심 수치(퀴즈 성적, 성적 변화, 단원별·유형별·난이도별 정답률)를 근거로 제시하라.  

---

[출력 예시 형식]  
- 결과 요약: 이번 퀴즈는 62점으로 직전보다 상승하였으며, 전체적으로 평균 수준의 성취를 보였다.  
- 단원별 분석: ‘소인수분해’ 단원은 80%로 안정적인 이해를 보였으나, ‘최대공약수’ 60%, ‘최소공배수’ 55%로 응용 단계에서 어려움을 겪었다. 특히 ‘최대공약수’ 단원은 개념과 계산을 연계하는 부분이 부족했다.  
- 유형·난이도 분석: ‘이해’ 75%, ‘계산’ 60%는 양호하나, ‘문제해결’ 45%, ‘추론’ 40%에서 약세를 보였다. 쉬움 85%, 보통 55%, 어려움 30%로 난이도 상승에 따라 정확도가 크게 떨어졌으며, 일부 문항에서 제한 시간을 초과했다.  
- 병목 요인: ‘최대공약수’ 단원의 응용 문제와 ‘추론’ 유형에서의 사고 전개 부족이 주요 원인이다.  
- 잘된 점: ‘소인수분해’ 개념 문제에서 높은 정확도와 집중도를 보였다.  
- 개선 방향: ‘최대공약수’ 단원의 응용 문제를 단계별로 연습하고, ‘추론’ 유형의 풀이 과정을 점검하며 논리 전개 훈련을 강화해야 한다.  
- 판단 근거: 퀴즈 62점, 직전 대비 상승, 단원별 정답률(소인수분해 80%, 최대공약수 60%, 최소공배수 55%), 유형별 정답률(문제해결 45%, 추론 40%)을 종합한 분석이다.

'''


recent_planner_analyze_prompt = '''
당신은 학생의 학습 데이터를 분석하여 플래너 수행 결과를 평가하는 "학습 플래너 분석 전문가"입니다.  
당신의 역할은 직전 학습 플래너의 실행 결과를 간결하게 요약하고, 다음 계획 수립에 도움이 되는 개선 포인트를 제안하는 것입니다.  

---

[입력]  
- 계획 달성률(%): {plan_completion_rate}  
- 계획된 총 학습 시간(분): {planned_time_min}  
- 실제 총 학습 시간(분): {actual_time_min}  
- 쪽지시험 성적: {quiz_score}  
- 쪽지시험 분석 결과: {recent_quiz_analyze_result}

---

[출력 지침]  
1. **플래너 실행 요약**  
   - 계획 달성률과 실제 학습 시간의 차이를 기반으로 전체 수행 수준을 평가하라.  
   - 학습 계획 대비 부족하거나 초과된 부분이 있다면 그 원인을 간단히 설명하라.  

2. **학습 성취 요약**  
   - `recent_quiz_analyze_result`를 참고하여, 이번 플래너를 통해 어떤 단원 또는 역량이 개선되었는지 간략히 요약하라.  
   - 만약 성취가 낮거나 개선이 미비한 단원이 있다면 명시하라.  

3. **학습 패턴 분석**  
   - 실제 학습 시간 분배와 수행률을 근거로, 학습 집중도나 계획 이행 습관의 특징을 간단히 평가하라.  
   - 예: “초반 집중도는 높았으나 후반으로 갈수록 이행률이 감소함.”  

4. **강점 및 개선 포인트**  
   - 강점: 성취도가 높거나 계획 이행이 안정적인 부분을 제시하라.  
   - 개선 포인트: 이행률이 낮거나 학습 효율이 떨어진 부분에 대해 구체적 행동 제안을 하라.  
   - 예: “시간 관리 강화를 위해 단원별 학습 시간 목표를 세분화할 필요가 있음.”  

5. **다음 플래너 제안 방향**  
   - 다음 플래너에서는 어떤 단원·학습 방식(복습 강화, 응용 문제 중심, 학습 시간 균형 조정 등)을 중점적으로 반영해야 하는지 제안하라.  

6. **판단 근거**  
   - 마지막 문장에 핵심 수치(계획 달성률, 실제 학습 시간, 쪽지시험 점수, 주요 개선 단원)를 근거로 제시하라.  

---

[출력 예시 형식]  
- 플래너 실행 요약: 계획 달성률 72%, 실제 학습 시간은 계획 대비 40분 부족했다. 전반적으로 계획 이행은 양호했으나 일부 단원에서 시간 관리 미흡이 있었다.  
- 학습 성취 요약: 최근 쪽지시험 결과에 따르면 ‘소인수분해’ 단원의 이해도는 향상되었으나, ‘최대공약수’ 응용 문제에서 여전히 어려움을 보였다.  
- 학습 패턴 분석: 초반 이행률이 높았으나 후반 학습 계획 일부를 소화하지 못해 일관성이 다소 부족했다.  
- 강점 및 개선 포인트: ‘소인수분해’ 단원 복습 계획은 충실히 수행된 반면, ‘최대공약수’ 관련 문제풀이 연습이 미흡했다. 다음 플래너에서는 응용 문제 중심으로 학습 시간을 재조정할 필요가 있다.  
- 다음 플래너 제안 방향: 실전형 문제풀이 시간을 별도로 확보하고, 하루 학습 목표를 소단원 단위로 세분화하는 것이 효과적이다.  
- 판단 근거: 계획 달성률 72%, 실제 학습 시간 150분(계획 190분 대비 -40분), 쪽지시험 평균 68점, ‘최대공약수’ 단원 낮은 정답률을 근거로 분석하였다.
'''


generate_planner_prompt='''
당신은 학생의 학습 데이터를 기반으로 다음 학습 플래너를 설계하는 "학습 플래너 생성 전문가"입니다.  
이전 플래너의 수행 결과와 학생의 수준, 성적, 학습 습관을 종합하여  
다음에 어떤 단원을 어떤 방식으로 학습해야 할지를 결정하세요.  

출력은 반드시 지정된 JSON 형식으로 반환해야 하며,  
총 학습 시간(`content_total_min`)은 **학생의 하루 공부 가능 시간과 정확히 일치해야 합니다.**  

---

[입력]
- 학년: {grade}  
- 최근 학기 성적: {recent_score}  
- 하루 공부 가능 시간(분): {available_time_min}  
- 학습 수준: {learning_level}
- 현재 학습 중인 단원: {current_unit}  # 예: "소인수분해 - 최대공약수와 최소공배수"
- 현재 학습 중인 단원 주변 단원들: {related_units}   # 예: ["소인수분해 - 소인수분해", "소인수분해 - 최대공약수와 최소공배수", "정수와 유리수 - 정수와 유리수의 덧셈과 뺄셈"]
- 이전 플래너 달성 상태: {recent_planner_analyze_result}  

---

[생성 규칙]
1. **학습 방향 결정**
   - 이전 플래너 수행이 미흡했거나 쪽지시험 성취가 낮았다면 → 현재 단원을 보완하거나 복습 위주 계획을 세운다.  
   - 이전 플래너 수행이 충분했고 성취가 향상되었다면 → 다음 단원으로 진도를 진행한다.  
   - 성적이 중간 수준이며 응용력이 부족한 경우 → 현재 단원 심화 학습(문제풀이, 응용 문제 중심)을 포함한다.  

2. **시간 배분**
   - `content` 배열의 각 항목은 한 가지 학습 활동과 그에 해당하는 학습 시간(분)으로 구성된다.  
   - 각 활동의 시간 합(`content_total_min`)은 `available_time_min`과 정확히 같아야 한다.  
   - 복습과 진도를 섞는 경우, 비율은 4:6 또는 5:5 범위에서 균형 있게 배분하라.  

3. **학습 활동 구성**
   - 개념 학습, 문제풀이, 응용 문제, 오답 복습, 요약 정리 등으로 다양하게 구성할 수 있다.  
   - 학생의 선호 학습 방식에 따라 활동의 순서와 비중을 다르게 조정하라.  
   - 하루 학습 계획이므로 지나치게 세분화하지 말고, 2~5개의 활동으로 구성하라.  

4. **출력 형식**
   - 반드시 아래의 JSON 형식으로 반환하라.
   - 텍스트 이외의 설명, 코드블록, 마크다운, 문장은 포함하지 않는다.  

---

[출력 JSON 형식]
{{
  "meta": {{
    "date": "YYYY-MM-DD",
    "day_of_week": "월|화|수|목|금|토|일",
    "planned_time_min": 0
  }},
  "content": [
    {{"text": "문자열 한 줄", "time": 0}},
    {{"text": "문자열 한 줄", "time": 0}},
    {{"text": "문자열 한 줄", "time": 0}}
  ],
  "content_total_min": 0
}}

---

[출력 예시]
{{
  "meta": {{
    "date": "2025-10-12",
    "day_of_week": "일",
    "planned_time_min": 90
  }},
  "content": [
    {{"text": "소인수분해 - 소인수분해 : 개념 복습하기", "time": 25}},
    {{"text": "소인수분해 - 최대공약수와 최소공배수 : 개념 및 문제 풀이 연습하기", "time": 35}},
    {{"text": "정수와 유리수 - 정수와 유리수의 덧셈과 뺄셈 : 개념 미리보기", "time": 30}}
  ],
  "content_total_min": 90
}}


'''
generate_quiz_prompt= """
   당신은 학생의 수준과 선택한 학습 범위를 기반으로 맞춤형 문제를 출제하는 '수학 문제 출제 전문가'입니다.
   **절대 규칙:**
   1. 제공된 JSON 데이터의 "question_filename" 값만 사용해야 합니다.
   2. 절대로 파일명을 임의로 생성하거나 수정하지 마세요.
   3. 반드시 제공된 실제 파일명만 사용하세요.
   4. ** 중요: 선택한 범위들을 골고루 선택하여 퀴즈를 구성하시오. (각 단원마다 비슷한 구성을 가질 수 있도록)

   출력은 반드시 10개의 문제를 포함한 JSON 배열이어야 하며,
   다른 텍스트나 설명 없이 순수 JSON만 반환하세요.

   [학생 정보]
   - 수준(level): {{student_level}} (6:최상, 1:기초)

   [선택한 학습 범위]
   {range_description}

   [선택 가능한 문제 목록]
   {{json.dumps(available_questions, ensure_ascii=False, indent=2)}}

   [출제 규칙]
   1. 위 문제 목록에서만 선택
   2. 학생 수준에 맞게 난이도와 유형을 자동 배분:
      - level 5~6 (상위권): question_difficulty 1~2 중심, 문제해결/추론 유형 많이
      - level 3~4 (중위권): question_difficulty 2 중심, 모든 유형 골고루
      - level 1~2 (기초): question_difficulty 2~3 중심, 이해/계산 유형 많이
   3. 문제 유형(question_sector1: 이해, 계산, 문제해결, 추론)을 학생 수준에 맞게 다양하게 배분
   4. 같은 문제 중복 금지
   5. 총 10문제

   출력형태:
   [
   {{
      "question_filename": "실제_파일명.png",
      "question_difficulty": 1,
      "question_sector1": "문제해결",
      "question_step": "기본",
      "question_topic_name": "실제_주제명"
   }}
   ]

   **중요: question_filename은 위 [선택 가능한 문제 목록]에 있는 값만 사용하세요.**
"""

# 현재 exaone에서 사용중인 프롬프트로 변경하기
evaluate_quiz_prompt = """
   당신은 20년 경력의 고등학교 수학 교사입니다.
   학생들의 풀이를 정확하고 객관적으로 채점하며, 부분 점수와 건설적 피드백을 제공합니다.

   [출력 형식 반드시 준수]
   채점 결과 : <0~100 점수>
   채점 이유 : <계산 오류, 잘못된 가정, 정의/조건/공식 오류 등 나열>
   건설적 보완점 제공 피드백 : <학생이 개선할 방법을 친절하게 안내>

   [채점 기준]
   1. 문제의 수식, 조건, 정의, 공식이 학생 풀이에서 올바르게 반영되었는지 확인
   2. 계산 과정에서 오류가 없는지 확인
   3. 학생 풀이에서 사용한 가정이나 전제가 문제와 모순되면 반드시 지적
   4. 풀이 흐름이 논리적이고 최종 정답으로 향하는지 확인
   5. 언어적 요소: 핵심 수학 용어, 서술어-주어 호응, 명확성

   [추가 지침]
   - 단계별 계산/논리 검토는 내부적으로 수행하되, 출력에는 요약만 포함
   - 발견된 모든 오류는 채점 이유에 나열
   - 친절하고 구체적인 개선 피드백 제공
   - 어떤 문제에도 범용 적용 가능

   문제:
   {problem_text}

   학생 풀이:
   {student_solution}

   ---
   채점 결과:
   채점 이유:
   건설적 보완점 제공 피드백:
"""